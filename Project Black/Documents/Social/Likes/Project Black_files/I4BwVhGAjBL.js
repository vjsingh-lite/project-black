/*1301360006,169776066*/

if (window.CavalryLogger) { CavalryLogger.start_js(["nruSN"]); }

var MessagingEvents=window.MessagingEvents||(function(){onloadRegister(function(){var b=0;MessagingEvents.subscribe('mark-as-read',function(){b++;var d=function(){MessagingEvents.unsubscribe(e);clearTimeout(c);b--;};var e=MessagingEvents.subscribe('read',d);var c=d.defer(60000);});var a=function(c){if(b)return;for(var d in c)MessagingEvents.inform('count/'+d,c[d]);};Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messaging'),function(c,e){var f=copy_properties(e.obj);var event=f.event||'';delete f.type;delete f.event;MessagingEvents.inform(event,f);if('unread_counts' in f){var d=f.unread_counts;a({unread:d.inbox,other_unseen:d.other});}});Arbiter.subscribe(PresenceMessage.getArbiterMessageType('inbox'),function(c,d){var e=copy_properties(d.obj);delete e.type;a(e);});});return new Arbiter();})();
add_properties('Messaging',{getUserThreadURI:function(a){return URI(env_get('www_base')).setPath('/messages/'+a);},markAsRead:function(a){a=$A(a);new AsyncRequest().setURI('/ajax/messaging/async.php').setData({action:'markRead',tids:a}).setMethod('POST').setHandler(bagofholding).setErrorHandler(bagofholding).send();MessagingEvents.inform('mark-as-read',{tids:a});},markUserThreadAsRead:function(a){new AsyncRequest().setURI('/ajax/messaging/async.php').setData({action:'chatMarkRead',other_user:a}).setMethod('POST').setHandler(bagofholding).setErrorHandler(bagofholding).send();MessagingEvents.inform('mark-as-read',{chat_ids:[a]});}});
var MessagingConst={APP_ID:313785040330,XD_MESSAGE:{SANDBOX_READY:'sandbox_ready',SET_CONTENT:'set_content',HTML_SIZE:'html_size',REFRESH_SIZE:'refresh_size'},SHINGLE_SCROLL_TRIGGER:5,EVENTS:{MESSAGE_SENT:'messaging/message_sent'}};
function MessagingJewelMenubarController(b,a){this.parent.construct(this);this._content=ge(a);this._open=false;Arbiter.subscribe([MessagingConst.EVENTS.MESSAGE_SENT,'chat/message-sent'],this._onSend.bind(this));Toggler.listen(['show','hide'],$(b),this._onToggle.bind(this));this._init();}MessagingJewelMenubarController.extend('MenubarMessageController');copy_properties(MessagingJewelMenubarController,{ensureInitialized:function(c,b,a){if(MessagingJewelMenubarController.initialized||!ge(b))return false;var d=new MessagingJewelMenubarController(c,b);MessagingJewelMenubarController.instance=d;MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);d.mouseOverListener.remove();MessagingJewelMenubarController.initialized=true;}});copy_properties(MessagingJewelMenubarController.prototype,{_init:function(){this.initializeEvents();},initializeEvents:function(){var a=null;Event.listen(this._content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},_fetch:function(){new AsyncRequest().setURI('/ajax/messaging/async.php').setMethod('GET').setData({action:'threadlist',preview:true}).setReadOnly(true).send();},_onSend:function(){this._dirty=true;},onCounterUpdate:function(){this.parent.onCounterUpdate();if(this._open)this.doRefetch();},_onToggle:function(b,a){this._open=(b=="show");}});