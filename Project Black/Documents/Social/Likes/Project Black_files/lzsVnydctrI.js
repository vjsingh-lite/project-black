/*1302555908,169775812*/

if (window.CavalryLogger) { CavalryLogger.start_js(["my1rm"]); }

var NotificationCounter=(function(){var a={messages:0,notifications:0,requests:0};return {init:function(){Arbiter.subscribe('update_title',this._handleUpdate.bind(this));Arbiter.subscribe(['jewel/messages-updated','jewel/requests-updated','jewel/notifications-updated'],this._handleCountUpdate.bind(this));},getCount:function(){return a.requests+a.messages+a.notifications;},updateTitle:function(){var b=DocumentTitle.get();var c=this.getCount();DocumentTitle.set(c?b+' ('+c+')':b,true);},_handleCountUpdate:function(c,b){a[b.jewel]=b.count;this.updateTitle();},_handleUpdate:function(c,b){this.updateTitle();}};})();
function RenderManager(a){copy_properties(this,{_isDirty:false,_obj:a});}copy_properties(RenderManager.prototype,{dirty:function(){if(!this._isDirty){this._isDirty=true;bind(this,this.doPaint).defer();}},doPaint:function(){this._isDirty=false;this._obj.paint();}});
function CounterDisplay(a,g,h,e,d,b){copy_properties(this,{_name:a,_valueNode:$(g),_wrapperNode:$(h)||null,_statusClass:d,_rm:new RenderManager(this),_arbiterSubscription:null,_count:0});var c=this._valueNode.firstChild;if(c){var f=parseInt(c.nodeValue,10);if(!isNaN(f))this._count=f;}this._statusNode=e?$(e):null;this._subscribeAll();CounterDisplay.instances.push(this);if(!b)onleaveRegister(this._destroy.bind(this),true);}copy_properties(CounterDisplay,{EVENT_TYPE_ADJUST:'CounterDisplay/adjust',EVENT_TYPE_UPDATE:'CounterDisplay/update',instances:[],adjustCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_ADJUST+'/'+a,b);},setCount:function(a,b){Arbiter.inform(CounterDisplay.EVENT_TYPE_UPDATE+'/'+a,b);}});CounterDisplay.mixin({_destroy:function(){delete this._valueNode;delete this._wrapperNode;if(this._arbiterSubscription){Arbiter.unsubscribe(this._arbiterSubscription);delete this._arbiterSubscription;}CounterDisplay.instances.remove(this);},adjustCount:function(a){this._count=Math.max(0,this._count+a);this._rm.dirty();return this;},setCount:function(a){this._count=Math.max(0,a);this._rm.dirty();return this;},paint:function(){DOM.setContent(this._valueNode,this._count);if(this._wrapperNode)CSS.conditionClass(this._wrapperNode,'hidden_elem',this._count<=0);if(this._statusClass&&this._statusNode)CSS.conditionClass(this._statusNode,this._statusClass,this._count>0);},_subscribeAll:function(){var a=[CounterDisplay.EVENT_TYPE_ADJUST+'/'+this._name,CounterDisplay.EVENT_TYPE_UPDATE+'/'+this._name];this._arbiterSubscription=Arbiter.subscribe(a,this._onInform.bind(this),Arbiter.SUBSCRIBE_NEW);},_onInform:function(a,b){b=parseInt(b);if(isNaN(b))return;if(a.indexOf(CounterDisplay.EVENT_TYPE_ADJUST)!=-1){this.adjustCount(b);}else if(a.indexOf(CounterDisplay.EVENT_TYPE_UPDATE)!=-1){this.setCount(b);}else return;return;}});
function MenubarMessageController(b,a){}copy_properties(MenubarMessageController,{ensureInitialized:function(c,b,a){if(MenubarMessageController.initialized||!ge(b))return false;var d=new MenubarMessageController(c,b);MenubarMessageController.instance=d;d.ensureInitialized(c,b,a);MenubarMessageController.initialized=true;}});copy_properties(MenubarMessageController.prototype,{ensureInitialized:function(c,b,a){this.menu=ge(b);var d=[CounterDisplay.EVENT_TYPE_ADJUST+'/messages_unread',CounterDisplay.EVENT_TYPE_UPDATE+'/messages_unread'];Arbiter.subscribe(d,this.onCounterUpdate.bind(this),Arbiter.SUBSCRIBE_NEW);Arbiter.subscribe(PresenceMessage.getArbiterMessageType('messages_seen'),function(){CSS.removeClass($('mailWrapper'),'jewelNew');Arbiter.inform('jewel/messages-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);});this._dirty=a;this.mouseOverListener=Event.listen($(c),'mouseover',this.doRefetch.bind(this));},doRefetch:function(){if(this._dirty){this._dirty=false;this._fetch();}},_fetch:function(){new AsyncRequest().setURI('/ajax/gigaboxx/endpoint/ListThreads.php').setMethod('GET').setReadOnly(true).setHandler(this.onFetchComplete.bind(this)).setData({folder:'[fb]messages',start:0,limit:5,previews:true}).send();},onFetchComplete:function(a){if(this.menu)DOM.setContent(this.menu,HTML(a.payload));},onCounterUpdate:function(){this._dirty=true;}});
var Jewel={markSeen:function(b,c,a){if(c){CSS.removeClass(a,'jewelNew');if(b=='[fb]messages'){MenubarMessageController.instance.doRefetch();Arbiter.inform('jewel/messages-updated',{jewel:'messages',count:0},Arbiter.BEHAVIOR_STATE);}else if(b=='[fb]requests')Arbiter.inform('jewel/requests-updated',{jewel:'requests',count:0},Arbiter.BEHAVIOR_STATE);new AsyncSignal('/ajax/gigaboxx/endpoint/UpdateLastSeenTime.php',{folder:b}).send();}else if(/requests/.test(b))DOM.scry(a,'li.jewelItemNew').each(function(d){CSS.removeClass(d,'jewelItemNew');});}};
Dcode=function(){var a,d={},b={_:'%',A:'%2',B:'000',C:'%7d',D:'%7b%22',E:'%2c%22',F:'%22%3a',G:'%2c%22ut%22%3a1',H:'%2c%22bls%22%3a',I:'%2c%22n%22%3a%22%',J:'%22%3a%7b%22i%22%3a0%7d',K:'%2c%22pt%22%3a0%2c%22vis%22%3a',L:'%2c%22ch%22%3a%7b%22h%22%3a%22',M:'%7b%22v%22%3a2%2c%22time%22%3a1',N:'.channel%22%2c%22sub%22%3a%5b',O:'%2c%22sb%22%3a1%2c%22t%22%3a%5b',P:'%2c%22ud%22%3a100%2c%22lc%22%3a0',Q:'%5d%2c%22f%22%3anull%2c%22uct%22%3a',R:'.channel%22%2c%22sub%22%3a%5b1%5d',S:'%22%2c%22m%22%3a0%7d%2c%7b%22i%22%3a',T:'%2c%22blc%22%3a1%2c%22snd%22%3a1%2c%22ct%22%3a',U:'%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',V:'%2c%22blc%22%3a0%2c%22snd%22%3a0%2c%22ct%22%3a',W:'%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',X:'%2c%22ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',Y:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22ct%22%3a',Z:'%2c%22sb%22%3a1%2c%22t%22%3a%5b%5d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%2c%22blo%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a'};function c(){var f=[];for(var e in b){d[b[e]]=e;f.push(b[e]);}f.reverse();a=new RegExp(f.join("|"),'g');}return {encode:function(e){c();return encodeURIComponent(e).replace(/([_A-Z])|%../g,function(g,f){return f?'%'+f.charCodeAt(0).toString(16):g;}).toLowerCase().replace(a,function(f){return d[f];});},decode:function(e){return decodeURIComponent(e.replace(/[_A-Z]/g,function(f){return b[f];}));}};}();
Dcode_deprecated=function(){var a,d={},b={_:'%',A:'%22%3a',B:'%2c%22',C:'%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c%22bl%22%3a%7b%22ac%22%3a',D:'%7b%22',E:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a',F:'ri%22%3a0%7d%2c%22state%22%3a%7b%22p%22%3a0%2c%22ut%22%3a1',G:'%2c%22ch%22%3a%7b%22h%22%3a%22channel',H:'%22%2c%22p%22%3a80%2c%22sub%22%3a%5b',I:'%7d%7d',J:'%7b%22v%22%3a2%2c%22time%22%3a1',K:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a1%2c%22ts%22%3a1',L:'%5d%2c%22p%5f',M:'%22%3a0%2c%22',N:'%22%3a%7b%22i%22%3a0%2c%22all%46lids%22%3a%5bnull%5d',O:'0000',P:'%22%3a1',Q:'%7d',R:'%2c%22pt%22%3a0%2c%22vis%22%3a0%2c%22bls%22%3a0%2c%22blc%22%3a0%2c%22snd%22%3a1%2c%22blo%22%3a0%2c%22bvt%22%3a0%2c%22ct%22%3a0%2c%22sb%22%3a1%2c%22t%22%3a%7b%7d%2c%22f%22%3anull%2c%22uct%22%3a0%2c%22s%22%3a0%7d%2c2bl%22%3a%7b%22ac%22%3a0%2c%22ut',S:'%22%3a%7b%22ol%22%3a%2d1%2c%22exp%22%3a1',T:'fl%22%3a%5b%22%2d1%22%5d%2c%22all%46lids%22%3a%5b%22%2d1%22%5d',U:'ud%22%3a900%2c%22lc%22%3a0%2c%22cvr%22%3a%7b',V:'%2c%22ut%22%3a1',W:'%2c%22pt%22%3a0%2c%22vis%22%3a1%2c%22bls',X:'%2c%22lc%22%3a1%2c%22cvr%22%3a%7b%22r%22%3a0%2e',Y:'%22%3a%7b%22n%22%3a%22%',Z:'%2c%22ud%22%3a'};function c(){var f=[];for(var e in b){d[b[e]]=e;f.push(b[e]);}f.reverse();a=new RegExp(f.join("|"),'g');}return {encode:function(e){c();return encodeURIComponent(e).replace(/([_A-Z])|%../g,function(g,f){return f?'%'+f.charCodeAt(0).toString(16):g;}).toLowerCase().replace(a,function(f){return d[f];});},decode:function(e){return decodeURIComponent(e.replace(/[_A-Z]/g,function(f){return b[f];}));}};}();
function CookieManager(b,a){this.version=b;this.cookieName='presence';this.dictEncode=a;this.storers={};this.requireUserCookie=false;Arbiter.inform('presence-cookie-manager/initialized',this,Arbiter.BEHAVIOR_PERSISTENT);}CookieManager.prototype={register:function(b,a){this.storers[b]=a;},store:function(){var a=this._getCookie();if(a&&a.v&&this.version<a.v){presence.versionShutdown();return;}var b={v:this.version,time:parseInt(presence.getTime()*.001)};for(var d in this.storers)b[d]=this.storers[d]();var c=JSON.stringify(b);if(this.dictEncode)c='E'+Dcode.encode(c);if(!this.requireUserCookie||presence.hasUserCookie(false))setCookie(this.cookieName,c,null);},clear:function(){clearCookie(this.cookieName);},_getCookie:function(){try{var data=getCookie(this.cookieName);if(this.lastD===data){return this.lastV;}else{this.lastD=data;this.lastV=null;}if(data&&data.charAt(0)=='E'){data=Dcode.decode(data.substring(1));}else if(data&&data.charAt(0)=='D')data=Dcode_deprecated.decode(data.substring(1));if(data){this.lastV=JSON.parse(data);return this.lastV;}}catch(a){}return null;},getSubCookie:function(b){var a=this._getCookie();if(!a)return null;return a[b];},setCheckUserCookie:function(a){this.requireUserCookie=a;}};
function ChatNotificationList(){this.alertIds=[];this.alertsObj={};this.contentRoot=null;this.noItemsElement=null;this.ITEM_UNREAD_CLASS='jewelItemNew';this.ITEM_TAG='li';this.ITEM_CLASS='notification';this.NO_ITEMS_ID='jewelNoNotifications';this.NO_ITEMS_CLASS='empty';}ChatNotificationList.prototype={setUnreadItemClass:function(a){this.ITEM_UNREAD_CLASS=a;},setItemTag:function(a){this.ITEM_TAG=a;},setItemClass:function(a){this.ITEM_CLASS=a;},setNoItemsClass:function(a){this.NO_ITEMS_CLASS=a;},getAlertIds:function(){return this.alertIds;},fromDom:function(b){this.contentRoot=b;var f=this.ITEM_TAG;if(this.ITEM_CLASS)f+='.'+this.ITEM_CLASS;var d=DOM.scry(this.contentRoot,f);for(var e=0;e<d.length;e++){var c=d[e];var a=parseInt(c.getAttribute('id').replace('notification_',''),10);this.alertIds.push(a);this.alertsObj[a]=c;}this.alertIds.sort(function(g,h){return h-g;});},insert:function(a,b,c){a=parseInt(a,10);if(this.alertsObj[a])if(!c){return false;}else this.remove(a);DOM.prependContent(this.contentRoot,HTML(b));this.alertIds.unshift(a);this.alertsObj[a]=$('notification_'+a);if(1==this.size())hide(this.NO_ITEMS_ID);return true;},showNoNotifications:function(){if(null==this.noItemsElement)this.noItemsElement=ge(this.NO_ITEMS_ID);if(null==this.noItemsElement){this.noItemsElement=$N(this.ITEM_TAG,{id:this.NO_ITEMS_ID,className:this.NO_ITEMS_CLASS},_tx("No new notifications."));DOM.appendContent(this.contentRoot,this.noItemsElement);}CSS.show(this.NO_ITEMS_ID);},remove:function(b){var a=this.alertsObj[b];if(!this.alertsObj[b])return false;DOM.remove(a);delete this.alertsObj[b];this.alertIds.splice(this.alertIds.indexOf(b),1);if(this.isEmpty())this.showNoNotifications();return true;},getUnreadIds:function(a){var c=[];a=a||this.alertIds;for(var b=0;b<a.length;b++)if(this.isUnreadId(a[b]))c.push(a[b]);return c;},isUnreadId:function(a){var b=this.alertsObj[a];return (b&&CSS.hasClass(b,this.ITEM_UNREAD_CLASS));},markRead:function(a){for(var c=0;c<a.length;c++){var b=this.alertsObj[a[c]];b&&animation(b).duration(5000).checkpoint().to('backgroundColor','#FFFFFF').duration(2250).ondone(CSS.removeClass.bind(null,b,this.ITEM_UNREAD_CLASS)).go();}return 0!=a.length;},markReadNow:function(){for(var a in this.alertsObj)CSS.removeClass(this.alertsObj[a],this.ITEM_UNREAD_CLASS);},insertMany:function(d,e){var f=0;if('object'==typeof d&&!is_empty(d)){if(is_empty(e)){e=[];for(var b in d)e.push(b);e.sort(function(g,h){return h-g;});}for(var a=e.length-1;a>=0;--a){var c=e[a];if(this.insert(c,d[c],true))f++;}}if(0===f&&this.isEmpty()){this.showNoNotifications();}else hide(this.NO_ITEMS_ID);return f;},isEmpty:function(){return 0==this.size();},size:function(){return this.alertIds.length;}};function ChatNotifications(a){this.count=a.count||0;this.countNew=a.countNew||0;this.updateTime=a.updateTime||new Date().getTime();this.user=Env.user;this.cache_version=a.cacheVersion||0;this.allowDesktopNotifications=a.allowDesktopNotifications||false;this.latest_notif_time=a.latestNotif||0;this.latest_read_notif_time=a.latestReadNotif||0;this.update_period=a.updatePeriod||60000;this.notifReceivedType=a.notifReceivedType||'notification';this.wrapperID='notificationsWrapper';this.contentID='jewelNotifs';this.timeElement='small.time';this.alertList=new ChatNotificationList();this._init();}ChatNotifications.BEEPS_EXPIRED='beeper/beeps_expired';ChatNotifications.prototype={_init:function(){this.cookieName='notifications_'+this.user;this.beepsExpiredToken=null;this.updateCheckCount=0;this.wrapper=ge(this.wrapperID);this.content=ge(this.contentID);this.countSpan=ge('presence_notifications_count');this.alertList.fromDom(this.content);this._updateCount();this.initializeEvents();Arbiter.subscribe(PresenceMessage.getArbiterMessageType(this.notifReceivedType),this._handleNotificationMsg.bind(this));Arbiter.subscribe(PresenceMessage.getArbiterMessageType('notifications_read'),this._handleNotificationsReadMsg.bind(this));MessagingEvents.subscribe('count/unread',this._updateInboxUnreadCount.bind(this));MessagingEvents.subscribe('count/unseen',this._updateInboxUnseenCount.bind(this));MessagingEvents.subscribe('count/other_unseen',this._updateInboxOtherUnseenCount.bind(this));this._poller=new Poller(this.update_period,this._update.bind(this));if(this.wrapper){this.countSpan=DOM.find(this.wrapper,'span.jewelCount span');if(this.isTabOpen())this.loadTab();}},initializeEvents:function(){var a=null;Event.listen(this.content,{mouseover:function(event){var b=event.getTarget();a=Parent.byTag(b,'li');if(a)CSS.addClass(a,'selected');},mouseout:function(event){a&&CSS.removeClass(a,'selected');a=null;}});},notifyAndMarkRead:function(d,a){if(!(a&&a.length))return;if(!d){var b={render:0};for(var c=0;c<a.length;++c)b['alert_ids['+c+']']=a[c];new AsyncSignal('/ajax/presence/notifications_read.php',b).send();}this.alertList.markRead(a);},markRead:function(c,a,b){if(this.countNew===0)return;a=a||this.alertList.getUnreadIds();this.countNew=b?b:0;this.notifyAndMarkRead(c,a);this._updateCount();},_updateURI:'/ajax/presence/update.php',_update:function(a){a.setHandler(this._handleUpdate.bind(this)).setOption('suppressErrorAlerts',true).setData({user:this.user,notif_latest:this.latest_notif_time,notif_latest_read:this.latest_read_notif_time}).setURI(this._updateURI).setAllowCrossPageTransition(true);},_updateInboxOtherUnseenCount:function(a,b){CounterDisplay.setCount('other_unseen',b);},_updateInboxUnreadCount:function(a,b){CounterDisplay.setCount('messages_unread',b);},_updateInboxUnseenCount:function(a,b){CounterDisplay.setCount('messages_unseen',b);Arbiter.inform('jewel/messages-updated',{jewel:'messages',count:b},Arbiter.BEHAVIOR_STATE);},_handleUpdate:function(b){var a=b.payload.notifications;if(!a.no_change){if(this.count!=a.count)this.count=a.count;this.updateTime=b.payload.time;this.latest_notif_time=a.latest_notif;this.latest_read_notif_time=a.latest_read_notif;this.countNew=a.countNew;this._updateDisplayDelayed();this.alertList.insertMany(a.markup_map,a.order);Arbiter.inform(Arbiter.NEW_NOTIFICATIONS,a);}},_updateDisplayDelayed:function(){if(typeof Beeper!='undefined'){this.beepsExpiredToken=Arbiter.subscribe(ChatNotifications.BEEPS_EXPIRED,this._updateDisplay.bind(this));}else this._updateDisplay();},_updateDisplay:function(){if(!this.content)return;this._updateCount();if(this.beepsExpiredToken)Arbiter.unsubscribe(this.beepsExpiredToken);},_updateCount:function(){if(this.countSpan)DOM.setContent(this.countSpan,this.countNew);Arbiter.inform('jewel/notifications-updated',{jewel:'notifications',count:this.countNew},Arbiter.BEHAVIOR_STATE);CSS.conditionClass(this.wrapper,'jewelNew',(this.countNew>0));},loadTab:function(){if(!this.fetch())this.markRead();},fetch:function(){var a=URI('/ajax/presence/notifications_read.php');a.setQueryData({time:this.latest_notif_time,user:this.user,version:this.cache_version,render:1});var b=ge('presence_notifications_loading');new AsyncRequest().setURI(a).setStatusElement(b).setMethod('GET').setReadOnly(true).setHandler(this.fetchHandler.bind(this)).setAllowCrossPageTransition(true).send();return true;},fetchHandler:function(d){var c=d.getPayload();this.alertList.insertMany(c.markup_map,c.order);var b=ge('presence_notifications_loading');b&&DOM.remove(b);var e=c.generated;var a=Math.round((new Date()).getTime()/1000);if(a-e>15){e=a;this.alertList.markReadNow();}Bootloader.loadComponents('live-timer',function(){LiveTimer.restart(e);LiveTimer.startLoop(0);});this.markRead(true);this.fetch=bagofholding;},_mergeNotification:function(b,c,d){var a=!this.alertList.isUnreadId(b);this.alertList.insert(b,c,true);this.latest_notif_time=0;if(a){this.count++;if(d)this.countNew++;this._updateCount();}if(this.isTabOpen())this._merged_mouseover_handler=Event.listen(this.content,'mouseover',(function(){this._merged_mouseover_handler.remove();this.markRead();}).bind(this));var e=this.alertList.alertsObj[b];if(e)Bootloader.loadComponents('live-timer',function(){LiveTimer.addTimeStamps(e);});},_handleNotificationMsg:function(d,a){var b=a.obj;if(typeof this.useDesktopNotifications=='undefined'){var c;this.useDesktopNotifications=this.allowDesktopNotifications&&window.webkitNotifications&&window.webkitNotifications.checkPermission()===0;}if(this.useDesktopNotifications)Bootloader.loadComponents('desktop-notifications',function(){DesktopNotifications.addNotification(b.alert_id);});if(b.markup){this._mergeNotification(b.alert_id,b.markup,b.unread);}else this._poller.requestNow();},_handleNotificationsReadMsg:function(c,a){var b=a.obj;if(typeof Beeper!='undefined')Beeper.getInstance().markRead(true,b.alert_ids);this.markRead(true,b.alert_ids,b.num_unread);},isTabOpen:function(){return this.wrapper&&CSS.hasClass(this.wrapper,'jewelOn');}};
function SearchDataSource(a){this.minResults=3;this.maxResults=8;this.parent.construct(this,a);}SearchDataSource.extend('DataSource');SearchDataSource.prototype={init:function(){this.parent.init();this._leanPayload=null;this._bootstrapRequestsPending=0;this.active=false;this.updateMaxResults();Event.listen(window,'resize',this.updateMaxResults.bind(this));},dirty:function(){this.parent.dirty();this.tokensByField={};this.fetchOnUseRequests=[];this.fetchedLean=false;},asyncErrorHandler:function(a){if(window.Dialog&&Dialog.getCurrent()==null&&a.getError()==1400003)AsyncResponse.verboseErrorHandler(a);},fetch:function(b,a,c){c=c||{};c.fetch_start=this.time();this.parent.fetch(b,a,c);},fetchHandler:function(e,c){var d=e.getPayload();var f=copy_properties({fetch_end:this.time()},c);var b=f.value?Arbiter.BEHAVIOR_EVENT:Arbiter.BEHAVIOR_PERSISTENT;this.inform('endpointStats',f,b);if(d.fetcht==2){this._leanPayload=d;this.processLean();}else{this.parent.fetchHandler(e,c);if(c.bootstrap&&!d.no_data&&this._bootstrapRequestsPending>0){c.bootstrap=false;--this._bootstrapRequestsPending;!this._bootstrapRequestsPending&&this.bootstrapPostProcess();}if(d.stale||d.no_data){var a=copy_properties({},e.getRequest().getData());a.stale_ok=0;a.lazy=0;this.fetchOnUse(a,c);}}},bootstrapPostProcess:function(){var a={time:this.time()};this.inform('bootstrapped',a,Arbiter.BEHAVIOR_PERSISTENT);this.processLean();this.value&&this.query(this.value);},processLean:function(){if(this._leanPayload){var a=this._leanPayload.entries;for(var b in a)if(this.data.hasOwnProperty(b))this.data[b].index=a[b];this._leanPayload=null;}},getFieldTokens:function(c,b){if(!this.tokensByField.hasOwnProperty(c))this.tokensByField[c]={};if(!this.tokensByField[c].hasOwnProperty(b)){var a=this.data[c][b];this.tokensByField[c][b]=a?TypeaheadUtil.tokenize(a.join?a.join(' '):a):[];}return this.tokensByField[c][b];},updateMaxResults:function(){var a=window.innerHeight||document.documentElement.clientHeight;var b=Math.ceil(2+((a-370)/56));this.numResults=Math.max(this.minResults,Math.min(this.maxResults,b));this.respond(this.value,this.buildUids(this.flatValue));},mergeUids:function(a,c,b,e){var d=function(f,g){var h=this.data[f];var i=this.data[g];if((h.extended_match||false)!==(i.extended_match||false))return h.extended_match?1:-1;if(h.index!==i.index)return h.index-i.index;if(h.text.length!==i.text.length)return h.text.length-i.text.length;if(h.text!==i.text)return h.text<i.text?-1:1;return h.uid<i.uid?-1:1;}.bind(this);this.checkExtendedMatch(e,a);this.checkExtendedMatch(e,c);return a.sort(d).concat(c,b);},checkExtendedMatch:function(c,d){for(var a=0;a<d.length;++a){var b=this.data[d[a]];b.extended_match=b.tokens&&!TypeaheadUtil.isPrefixMatch(c,this.getFieldTokens(b.uid,'text'));}},multifetch:function(e,b){var d=copy_properties(b,this.bootstrapData);d.stale_ok=1;for(var f=0;f<e.length;++f){var a=copy_properties({filter:e[f]},d);var c={bootstrap:true,type:e[f].join('_')};this.fetch(this.bootstrapEndpoint,a,c);++this._bootstrapRequestsPending;}},fetchOnUse:function(b,c){var a=copy_properties(b,this.bootstrapData);if(this.active){this.fetch(this.bootstrapEndpoint,a,c);}else this.fetchOnUseRequests.push({args:a,ctx:c});},fetchLean:function(){if(this.fetchedLean)return;var a={filter:['user'],no_cache:1};if(this.leanOnAllTypes)a={no_cache:1};a.options=$A(a.options);a.options.push('lean');this.fetchOnUse(a,{type:'lean'});this.fetchedLean=true;},bootstrap:function(c){if(this._bootstrapped)return;if(this.bootstrapData.filter){this.fetch(this.bootstrapEndpoint,this.bootstrapData);}else{var a={filter:['event'],no_cache:1};this.fetchOnUse(a,{type:'event'});var b=[['user'],['app','page','group']];this.multifetch(b,c?{lazy:1}:{});}this.fetchLean();this._bootstrapped=true;},flushFetchOnUseRequests:function(){var c=this.fetchOnUseRequests.length;for(var b=0;b<c;++b){var a=this.fetchOnUseRequests[b];this.fetch(this.bootstrapEndpoint,a.args,a.ctx);}this.fetchOnUseRequests=[];},query:function(c,b,a){if(!this.active){this.active=true;this.flushFetchOnUseRequests();}this.parent.query(c,b,a);},onLoad:function(b,a){this.inform('onload',{time:this.time()},Arbiter.BEHAVIOR_PERSISTENT);if(b){var c=this.lazyonload;if(a)this.active=true;this.bootstrap.bind(this,c).defer();}},time:function(){return +new Date();}};
function SearchTypeaheadCore(a){this.parent.construct(this,a);}SearchTypeaheadCore.extend('TypeaheadCore');SearchTypeaheadCore.prototype={init:function(a,f,d){this.parent.init(a,f,d);var b=Parent.byTag(d,'form'),c=this.reset.bind(this);if(b){var e=DOM.find(b,'input.search_sid_input');Event.listen(b,'submit',function(){if(this.data&&this.data.queryData)e.value=this.data.queryData.sid;c.defer();}.bind(this),Event.Priority.URGENT);}},select:function(){this.reset();this.element.focus();(function(){this.element.blur();}).bind(this).defer();},handleTab:function(event){var a=this.view.getQuerySuggestion(this.value);if(a){Input.setValue(this.element,a);this.checkValue();event.kill();}else this.parent.handleTab(event);}};
function SearchTypeaheadRecorder(a){this.init(a);this.initEvents();}SearchTypeaheadRecorder.prototype={init:function(a){this.core=a.getCore();this.data=a.getData();this.view=a.getView();this.element=this.core.getElement();this.initTime=this.time();this._onloadTime=0;this.initStartTime=$('search_first_focus').value;this.bootstrapStats={bootstrapped:0};this._reset();},_reset:function(){this.stats={};this.avgStats={};var a=Math.random();this.data.setQueryData({sid:a});this.view.setSid(a);this.recordStat('sid',a);},initEvents:function(){this.core.subscribe('focus',function(event){if(!this.stats['session_start_time'])this.recordStat('session_start_time',this.time());}.bind(this));this.core.subscribe('blur',function(event){this.recordStat('session_end_time',this.time());this.submit();}.bind(this));this.view.subscribe('select',function(a,b){this.recordSelectInfo(b);}.bind(this));this.view.subscribe('render',function(a,b){this.recordRender(b);}.bind(this));this.data.subscribe('activity',function(a,b){this.recordStat('pending_request',b.activity);}.bind(this));this.data.subscribe('beforeQuery',function(a,b){if(!b.value)return;if(!this.stats.first_query_time)this.recordStat('first_query_time',this.time());this.query=b.value;this.recordCountStat('num_queries');}.bind(this));this.data.subscribe('queryEndpoint',function(a,b){this.recordCountStat('num_search_ajax_requests');this.recordAvgStat('endpoint_query_length',b.value.length);}.bind(this));this.data.subscribe('onload',function(a,b){this._onloadTime=b.time;}.bind(this));this.data.subscribe('bootstrapped',function(a,b){this.bootstrapStats.endTime=b.time;this.bootstrapStats.bootstrapped=1;}.bind(this));this.data.subscribe('endpointStats',function(a,c){var b=c.fetch_end-c.fetch_start;if(c.value){this.recordAvgStat('search_endpoint_ms_from_js',b);}else this.bootstrapStats[c.type]=b;}.bind(this));this.data.subscribe('query',function(a,b){this.recordAvgStat('num_results_from_cache',b.results.length);}.bind(this));Event.listen(this.element,'keydown',function(event){if(Event.getKeyCode(event)==KEYS.BACKSPACE)this.recordCountStat('backspace_count');}.bind(this));},recordStat:function(a,b){this.stats[a]=b;},recordCountStat:function(a){var b=this.stats[a];this.stats[a]=b?b+1:1;},recordAvgStat:function(a,b){if(this.avgStats[a]){this.avgStats[a][0]+=b;++this.avgStats[a][1];}else this.avgStats[a]=[b,1];},recordRender:function(a){this.results=a.filter(function(b){return b.type!='calltoaction'&&b.type!='header';});if(this.results.length>0&&!this.stats.first_result_time)this.recordStat('first_result_time',this.time());},recordSelectInfo:function(c){var f=c.selected;var b=this.view.bucketedUI?c.index-f.groupIndex-1:c.index;var d={href:f.path};var a=f.dataGT?{gt:JSON.parse(f.dataGT)}:{};user_action(d,'a',null,null,a);if(f.uid=='search'){this.recordStat('selected_search',1);}else{var g=f.rankType||f.render_type||f.type;var e=(g=='friend'?'user':g);this.recordStat('selected_'+e,1);this.recordStat('selected_position',b);this.recordStat('selected_type',g);this.recordStat('selected_name_length',f.text.length);this.recordStat('selected_id',f.uid);this.recordStat('selected_degree',f.bootstrapped?1:2);this.recordStat('selected_extended_match',f.extended_match);}this.recordStat('selected_with_mouse',c.clicked?1:0);},_dataToSubmit:function(){this.recordStat('candidate_results',this.buildResults());this.recordStat('query',this.query);this.recordStat('init_time',this.initTime);if(this.initStartTime){this.recordStat('init_start_time',this.initStartTime);this.recordStat('onload_time',this._onloadTime);this.initStartTime=0;}this.recordStat('bootstrapped',this.bootstrapStats.bootstrapped);if(this.bootstrapStats.endTime){this.recordStat('bootstrapped_time',this.bootstrapStats.endTime);this.recordStat('user_bootstrap_ms',this.bootstrapStats.user);this.recordStat('other_bootstrap_ms',this.bootstrapStats.app_page_group);this.bootstrapStats.endTime=0;}this.recordStat('max_results',this.data.numResults);var a=this.stats;for(var c in this.avgStats){var b=this.avgStats[c];a[c]=b[0]/b[1];}return a;},buildResults:function(){var a=(this.results||[]).map(function(d,c){var e=d.rankType||d.render_type||d.type;var b=d.bootstrapped?1:0;if(typeof d.groupIndex=='number')return [d.groupIndex,d.indexInGroup,d.uid,e,b];return [0,c,d.uid,e,b];});return JSON.stringify(a);},submit:function(){var a=this._dataToSubmit();if(count(a)>0)new AsyncRequest().setURI('/ajax/typeahead/record_metrics.php').setMethod('POST').setData({stats:a}).setOption('handleErrorAfterUnload',true).setErrorHandler(function(b){a.retry=true;new AsyncRequest().setURI('/ajax/typeahead/record_metrics.php').setMethod('POST').setData({stats:a}).setOption('asynchronous',false).send();}).send();this._reset();},time:function(){return (new Date()).getTime();}};
function SearchTypeaheadView(a,b){this.parent.construct(this,a,b);}SearchTypeaheadView.extend('TypeaheadView');SearchTypeaheadView.prototype={queryData:{init:'quick'},render:function(d,b,c){var a=b.length;if(this.bucketedUI)b=this.buildBuckets(b);if(d)b.push(this.buildSeeMore(d,a));return this.parent.render(d,b,c);},buildBuckets:function(f){var b=[];var h={};for(var d=0;d<f.length;++d){var c=f[d];var g=c.render_type||c.type;if(!h.hasOwnProperty(g)){h[g]=b.length;b.push([this.buildBucketHeader(g)]);}c.classNames=g;c.groupIndex=h[g];c.indexInGroup=b[c.groupIndex].length-1;b[c.groupIndex].push(c);}var a=[];for(var e=0;e<b.length;++e)a=a.concat(b[e]);return a;},buildSeeMore:function(d,b){var a='<span class="seeMore">'+(b>0?_tx("See more results for {query}",{query:htmlize(d)}):_tx("See results for {query}",{query:htmlize(d)}))+'<span class="arrow"></span></span>';if(b>0)a+='<span class="subtext">'+(b==1?_tx("Displaying top result"):_tx("Displaying top {number} results",{number:b}))+'</span>';var c=URI('/search.php').addQueryData(this.searchPageQueryData(d))+'';return {uid:'search',text:d,type:'calltoaction',path:c,markup:a};},buildBucketHeader:function(a){return this.typeObjects[a];},renderer:function(c,f){var j=c.markup||htmlize(c.text);var h=htmlize(c.subtext);var a=htmlize(c.category);var g=c.photo;var d=c.is_external;var e='',i='';var b=' class="'+(c.classNames||c.type)+'"';if(c.path){var k=c.path;if(!(/^https?\:\/\//).test(k))k=Env.www_base+k.substr(1);k+=(k.indexOf('?')>0?'&':'?')+'ref=ts';e=' href="'+k+'"';}if(d)i=' target="_blank"';if(a&&d)a+='<span class="arrow"></span>';return ['<li',b,'>','<a',e,i,' rel="ignore">',(g?('<img src="'+g+'" alt="" class="photo"/>'):''),(j?('<span class="text">'+j+'</span>'):''),(a?('<span class="category">'+a+'</span>'):''),(h?('<span class="subtext">'+h+'</span>'):''),'</a>','</li>'];},searchPageQueryData:function(b){var a=copy_properties({q:b},this.queryData||{});return a;},select:function(b){var e=this.results[this.index];if(!e||e.type=='header')return;var d=this.index,c=this.items[d],a=DOM.find(c,'a');this.parent.select(b);if(a&&a.href)if(a.target=='_blank'){window.open(a.href);}else goURI(a.href);},buildMarkup:function(b){var a=this.parent.buildMarkup(b);if(this.bucketedUI)a='<div class="bucketed">'+a+'</div>';return '<div class="search">'+a+'</div>';},setSid:function(a){this.queryData.tas=a;},getQuerySuggestion:function(c){var a=this.results[this.index];var b=a&&a.type!='header'?a.text.toLowerCase():'';return b==c.toLowerCase()?'':b;},getDefaultIndex:function(c){var a=(this.autoSelect&&!this.disableAutoSelect);var b=c.length===0?-1:(c[0].type=='header'?1:0);return this.index<0&&!a?-1:b;},prev:function(){if(this.results[this.index-1]&&this.results[this.index-1].type=='header')this.index--;return this.parent.prev();},next:function(){if(this.results[this.index+1]&&this.results[this.index+1].type=='header')this.index++;return this.parent.next();}};
add_properties('TypeaheadBehaviors',{searchRecorderBasic:function(a){a.subscribe('init',function(b,c){new SearchTypeaheadRecorder(a);});}});